# NMAP
Nmap: мощный инструмент для сканирования сетей

Nmap (сокращение от Network Mapper) — это один из наиболее известных инструментов для сканирования сетей и определения активных устройств. Написана она на языке C и находится в открытом доступе, что обеспечивает ее гибкость и расширяемость. Одна из главных особенностей Nmap заключается в том, что она может использоваться для определения огромного количества характеристик сетей, включая открытые порты, IP-адреса, версии операционных систем, доступные службы и т.д.

## Установка Nmap

Чтобы установить Nmap, необходимо просто скачать и установить архив с исходным кодом инструмента на официальном сайте https://nmap.org/. Кроме того, Nmap доступна в большинстве дистрибутивов Linux, таких как Ubuntu и Fedora. Для установки, нужно вызвать команду:
`sudo apt-get install nmap`

## Примеры использования Nmap для Linux-систем

Всли Вы подготовили свою тестовую среду — можно переходить к изучению примеров использования Nmap.
### №1 — сканирование указанного IP-адреса (IPv4) либо хоста 

Прежде всего нам пригодится команда, позволяющая просканировать конкретное имя хоста или определенный IP-адрес.
Сканируем один IP-адрес (IPv4)

`nmap 192.168.1.1`
Сканируем одно имя хоста, получая дополнительные данные

`nmap -v server1.sedicomm.com`

### №2 — сканирование сразу нескольких IP-адресов или подсетей (IPv4)

В реальной жизни очень редко удается обойтись сканированием одного единственного хоста за раз. К счастью, разработчик предусмотрел возможность одновременного сканирования нескольких IP-адресов.
Сканируем группу адресов IP
`nmap 192.168.1.1 192.168.1.2 192.168.1.3`
Сканируем группу подсетей 192.168.1.0/24
`nmap 192.168.1.1,2,3`
Сканируем диапазон IP-адресов
`nmap 192.168.1.1-20`
Cканируем диапазон IP-адресов с помощью метасимвола подстановки
`nmap 192.168.1.*`
Сканируем всю подсеть
`nmap 192.168.1.0/24`
### №3 — сканирование хостов/сетей (IPv4) по списку из файла
`nmap -iL /tmp/test.txt`
### №4 — исключение указанных хостов/сетей при сканировании

Возможна и обратная ситуация, при которой некоторые хосты или адреса IP не нужно сканировать. В этом случае их можно исключить опцией --exclude.
Исключение одного хоста по его IP-адресу
`nmap 192.168.1.0/24 --exclude 192.168.1.5`
Исключение нескольких хостов по их IP-адресам
`nmap 192.168.1.0/24 --exclude 192.168.1.5,192.168.1.254`
Исключение нескольких хостов, записанных в файл
`nmap -iL /tmp/scanlist.txt --excludefile /tmp/exclude.txt`
### №5 — скрипт сканирования ОС и определения версии
Nmap позволяет сканировать сеть на предмет получения данных об установленных ОС и их версиях. Для этого нужно использовать опцию -A.
Сканируем версию ОС
`nmap -A 192.168.1.254`
Сканируем версию ОС, получая дополнительные данные
`nmap -v -A 192.168.1.1`
Сканируем версию ОС по списку хостов из файла
`nmap -A -iL /tmp/scanlist.txt`
### №6 — выявление защиты брандмауэром или фильтрации пакетов у хоста/сети

Порой нужно узнать, на каких целевых машинах есть фильтрация пакетов. Обнаружить функционирующий брандмауэр можно с помощью опции -s.
Сканируем на наличие брандмауэра по IP-адресу
`nmap -sA 192.168.1.254`
Сканируем на наличие брандмауэра по имени хоста
`nmap -sA server1.sedicomm.com`

### №7 — сканирование хоста, защищенного брандмауэром

Также может возникнуть потребность в сканировании защищенного хоста. Сделать это поможет опция -PN, указывающая утилите Nmap пропустить этап пинга сканирования.
Сканирование хоста, защищенного брандмауэром, по его IP-адресу
`nmap -PN 192.168.1.1`
Сканирование хоста, защищенного брандмауэром, по имени хоста
`nmap -PN server1.sedicomm.com`
### №8 — сканирование хоста с адресом IPv6 с помощью Nmap для Linux
Утилита поддерживает сканирование IPv6 — для этого предназначена опция -6. В таком случае команды будут выглядеть следующим образом:

`nmap -6 IPv6-Address-Here2`

`nmap -6 server1.sedicomm.com3`

`nmap -6 2607:f0d0:1002:51::44`

`nmap -v A -6 2607:f0d0:1002:51::4`	

### №9 — поиск активных серверов и других устройств
Если возникла необходимость в обнаружении всех запущенных устройств сети, то самый простой способ это сделать — применить метод host discovery или ping scan:

`nmap -sP 192.168.1.0/242`

```Host 192.168.1.1 is up (0.00035s latency).3
MAC Address: BC:AE:C5:C3:16:93 (Unknown)4
Host 192.168.1.2 is up (0.0038s latency).5
MAC Address: 74:44:01:40:57:FB (Unknown)6
Host 192.168.1.5 is up.7
Host nas03 (192.168.1.12) is up (0.0091s latency).8
MAC Address: 00:11:32:11:15:FC (Synology Incorporated)9
Nmap done: 256 IP addresses (4 hosts up) scanned in 2.80 second
```	
### №10 — быстрое сканирование

В утилите предусмотрена возможность выполнения быстрого сканирования. Для этого предназначена опция -F утилиты Nmap:
`nmap -F 192.168.1.1`
### №11 — поиск причины, по которой порт находится в определенном состоянии

С помощью опции --reason можно узнать, по какой причине тот или иной порт был переведен утилитой в определенное состояние.
Узнаем причину текущего состояния порта по IP-адресу
`nmap --reason 192.168.1.1`
Узнаем причину текущего состояния порта по имени хоста
`nmap --reason server1.sedicomm.com`

### №12 — обнаружение всех открытых портов

Одной из самых полезных функций Nmap является способность искать открытые порты. Специально для этого предназначена опция --open.
Находим открытые порты по IP-адресу
`nmap --open 192.168.1.1`
Находим открытые порты по имени хоста
`nmap --open server1.sedicomm.com`

### №13 — вывод всех отправленных/полученных пакетов
Не менее важна функция просмотра отправленных и полученных пакетов с помощью Nmap. Для этого предназначена опция --packet-trace.
Выводим пакеты по IP-адресу
`nmap --packet-trace 192.168.1.1`
Выводим пакеты по имени хоста
`nmap --packet-trace server1.sedicomm.com`
### №14 — вывод интерфейсов хостов и маршрутов
Для отладки полезно уметь вывести на экран интерфейсы активных хостов и маршрутов. Утилита Nmap для Linux-систем может это сделать с помощью опции --iflist:

`nmap --iflist2`
```
Starting Nmap 5.00 ( http://nmap.org ) at 2012-11-27 02:01 IST3
INTERFACES4
DEV (SHORT) IP/MASK TYPE UP MAC5
lo (lo) 127.0.0.1/8 loopback up6
eth0 (eth0) 192.168.1.5/24 ethernet up B8:AC:6F:65:31:E57
vmnet1 (vmnet1) 192.168.121.1/24 ethernet up 00:50:56:C0:00:018
vmnet8 (vmnet8) 192.168.179.1/24 ethernet up 00:50:56:C0:00:089
ppp0 (ppp0) 10.1.19.69/32 point2point up10
ROUTES12
DST/MASK DEV GATEWAY13
10.0.31.178/32 ppp014
209.133.67.35/32 eth0 192.168.1.215
192.168.1.0/0 eth016
192.168.121.0/0 vmnet117
192.168.179.0/0 vmnet818
169.254.0.0/0 eth019
10.0.0.0/0 ppp020
0.0.0.0/0 eth0 192.168.1.2
```	
# №15 — сканирование конкретных портов
Утилита позволяет сканировать определенные порты, для этого можно использовать опцию -p:
`nmap -p [port] hostName`
Сканируем указанный порт
`nmap -p 80 192.168.1.1`
Сканируем указанный порт по TCP
`nmap -p T:80 192.168.1.1`
Сканируем указанный порт по UDP
`nmap -p U:53 192.168.1.1`
Сканируем два порта
`nmap -p 80,443 192.168.1.1`
Сканируем диапазон портов
`nmap -p 80-200 192.168.1.1`
Комбинируем опции сканирования
`nmap -p U:53,111,137,T:21-25,80,139,8080 192.168.1.12`
`nmap -p U:53,111,137,T:21-25,80,139,8080 server1.sedicomm.com3`
`nmap -v -sU -sT -p U:53,111,137,T:21-25,80,139,8080 192.168.1.254`
Сканируем все порты с помощью метасимвола подстановки «*»
`nmap -p "*" 192.168.1.1`
 
Scan top ports i.e. scan $number most common ports   
`nmap –top-ports 5 192.168.1.1`

`nmap –top-ports 10 192.168.1.1`

```Starting Nmap 5.00 ( <http://nmap.org> ) at 2012-11-27 01:23 IST
Interesting ports on 192.168.1.1:
PORT STATE SERVICE
21/tcp closed ftp
22/tcp open ssh
23/tcp closed telnet
25/tcp closed smtp
80/tcp open http
110/tcp closed pop3
139/tcp closed netbios-ssn
443/tcp closed https
445/tcp closed microsoft-ds
3389/tcp closed ms-term-serv
```
MAC Address: BC:AE:C5:C3:16:93 (Unknown)
Nmap done: 1 IP address (1 host up) scanned in 0.51 seconds

### №16 — экспресс-сканирование всех открытых портов в сети

Одной из самых нужных и востребованных возможностей утилиты Nmap является быстрый поиск открытых портов. Для его выполнения предназначена опция `-T5:
`nmap -T5 192.168.1.0/24J`

### №17 — удаленное выявление операционной системы с помощью Nmap для Linux

Утилита может опознавать ПО и даже операционные системы на удаленном хосте. В этом Вам поможет опция -O:

`nmap -O 192.168.1.12`


`nmap -O --osscan-guess 192.168.1.13`


`nmap -v -O --osscan-guess 192.168.1.14`

```
Starting Nmap 5.00 ( http://nmap.org ) at 2012-11-27 01:29 IST5
NSE: Loaded 0 scripts for scanning.6
Initiating ARP Ping Scan at 01:297
Scanning 192.168.1.1 [1 port]8
Completed ARP Ping Scan at 01:29, 0.01s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 01:2910
Completed Parallel DNS resolution of 1 host. at 01:29, 0.22s elapsed11
Initiating SYN Stealth Scan at 01:2912
Scanning 192.168.1.1 [1000 ports]13
Discovered open port 80/tcp on 192.168.1.114
Discovered open port 22/tcp on 192.168.1.115
Completed SYN Stealth Scan at 01:29, 0.16s elapsed (1000 total ports)16
Initiating OS detection (try #1) against 192.168.1.117
Retrying OS detection (try #2) against 192.168.1.118
Retrying OS detection (try #3) against 192.168.1.119
Retrying OS detection (try #4) against 192.168.1.120
Retrying OS detection (try #5) against 192.168.1.121
Host 192.168.1.1 is up (0.00049s latency).22
Interesting ports on 192.168.1.1:23
Not shown: 998 closed ports24
PORT STATE SERVICE25
22/tcp open ssh26
80/tcp open http27
MAC Address: BC:AE:C5:C3:16:93 (Unknown)28
Device type: WAP|general purpose|router|printer|broadband router29
Running (JUST GUESSING) : Linksys Linux 2.4.X (95%), Linux 2.4.X|2.6.X (94%), MikroTik RouterOS 3.X (92%), Lexmark embedded (90%), Enterasys embedded (89%), D-Link Linux 2.4.X (89%), Netgear Linux 2.4.X (89%)30
Aggressive OS guesses: OpenWrt White Russian 0.9 (Linux 2.4.30) (95%), OpenWrt 0.9 - 7.09 (Linux 2.4.30 - 2.4.34) (94%), OpenWrt Kamikaze 7.09 (Linux 2.6.22) (94%), Linux 2.4.21 - 2.4.31 (likely embedded) (92%), Linux 2.6.15 - 2.6.23 (embedded) (92%), Linux 2.6.15 - 2.6.24 (92%), MikroTik RouterOS 3.0beta5 (92%), MikroTik RouterOS 3.17 (92%), Linux 2.6.24 (91%), Linux 2.6.22 (90%)31
No exact OS matches for host (If you know what OS is running on it, see http://nmap.org/submit/ ).32
TCP/IP fingerprint:33
OS:SCAN(V=5.00%D=11/27%OT=22%CT=1%CU=30609%PV=Y%DS=1%G=Y%M=BCAEC5%TM=50B3CA34
OS:4B%P=x86_64-unknown-linux-gnu)SEQ(SP=C8%GCD=1%ISR=CB%TI=Z%CI=Z%II=I%TS=735
OS:)OPS(O1=M2300ST11NW2%O2=M2300ST11NW2%O3=M2300NNT11NW2%O4=M2300ST11NW2%O536
OS:=M2300ST11NW2%O6=M2300ST11)WIN(W1=45E8%W2=45E8%W3=45E8%W4=45E8%W5=45E8%W37
OS:6=45E8)ECN(R=Y%DF=Y%T=40%W=4600%O=M2300NNSNW2%CC=N%Q=)T1(R=Y%DF=Y%T=40%S38
OS:=O%A=S+%F=AS%RD=0%Q=)T2 (R=N)T3(R=N)T4(R=Y%DF=Y%T= 40%W=0%S=A%A=Z%F=R%O=%R3
OS:D=0%Q=)T5(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=) T6 (R=Y%DF=Y%T=40%W=40
OS:0%S=A%A=Z%F=R%O=%RD=0%Q=)T7(R=N) U1 (R=Y%DF=N%T=40%IPL=164%UN=0%RIPL=G%RID4
OS:=G%RIPCK=G%RUCK=G%RUD=G) IE (R=Y%DFI=N%T=40%CD=S)42
Uptime guess: 12.990 days (since Wed Nov 14 01:44:40 2012)43
Network Distance: 1 hop44
TCP Sequence Prediction: Difficulty=200 (Good luck!)45
IP ID Sequence Generation: All zeros46
Read data files from: /usr/share/nmap47
OS detection performed. Please report any incorrect results at http://nmap.org/submit/ .48
Nmap done: 1 IP address (1 host up) scanned in 12.38 seconds49
Raw packets sent: 1126 (53.832KB) | Rcvd: 1066 (46.100KB)
```
### №18 — проверка версий удаленных сервисов (сервер / демон)
Также программа может выяснить то, какие версии сервисов работают на удаленных хостах. Для этого нужно использовать опцию -sV:

`nmap -sV 192.168.1.12`

### №19 — сканирование с помощью пинга TCP ACK (PA) и TCP Syn (PS)
Нередко брандмауэр отклоняет все запросы ICMP. В таком случае можно попробовать выполнить сканирование одним из следующих способов:

`nmap -PS 192.168.1.12`

`nmap -PS 80,21,443 192.168.1.13`

`nmap -PA 192.168.1.14`

`nmap -PA 80,21,200-512 192.168.1.1`

### №20 — сканирование хоста с помощью IP-протокола ping
С помощью Network Mapper можно выполнить пинг с использованием IP-протокола. Для этого воспользуйтесь опцией -PO:

`nmap -PO 192.168.1.1`

### №21 — сканирование хоста за счет UDP-пинга 
При работе с Nmap можно обойти межсетевые экраны с помощью UDP-пинга. Для этого попробуйте опцию -PU:

`nmap -PU 192.168.1.12`

`nmap -PU 2000.2001 192.168.1.1`

### №22 — поиск наиболее часто используемых портов TCP, с использованием TCP SYN Scan
Сканируем скрытно с TCP SYN
Можно выполнить полуоткрытое сканирование (TCP SYN) без установки полноценного подключения. Для этого воспользуйтесь опцией -sS: nmap -sS 192.168.1.1
Ищем с помощью TCP-подключения порты, которые чаще всего используются
`nmap -sT 192.168.1.1`
Ищем с помощью TCP ACK порты, которые чаще всего используются
`nmap -sA 192.168.1.1`
Ищем с помощью сканирования TCP Window порты, которые чаще всего используются
`nmap -sW 192.168.1.1`
Ищем с помощью сканирования TCP Maimon порты, которые чаще всего используются
`nmap -sM 192.168.1.1`
### №23 — сканирование хоста на предмет UDP-сервисов
Утилита предлагает обнаружение служб, пользующихся UDP-подключением. Для этого достаточно использовать опцию -sU:

`nmap -sU nas032`

`nmap -sU 192.168.1.13`

### №24 — сканирование поддерживаемых IP-протоколов
А еще можно выяснить, какие именно IP-протоколы доступны к применению на целевых машинах:

    TCP;
    ICMP;
    IGMP и другие.

Для этого нужно использовать опцию -sO: `nmap -sO 192.168.1.1`
### №25 — сканирование брандмауэра для обнаружения уязвимостей
Есть три типа сканирования, позволяющих получать сведения о настройках безопасности удаленных машин.
Сканируем TCP Null, позволяющим «обмануть» брандмауэр для получения ответа
Первый вариант оставляет заголовок флага TCP равным нулю (не устанавливает битов) с помощью опции -sN: nmap -sN 192.168.1.254
Сканируем TCP FIN для проверки брандмауэра
Второй вариант сканирования устанавливает только бит TCP FIN с помощью опции -sF: nmap -sF 192.168.1.254
Сканируем TCP Xmas для проверки брандмауэра
Третий вариант с помощью опции -sX устанавливает флаги FIN, PSH и URG, подсвечивая пакет не хуже новогодней елки: nmap -sX 192.168.1.254
### №26 — сканирование брандмауэра на наличие фрагментов пакетов
Флаг -f заставляет данное сканирование (включая проверки ping) использовать крошечные фрагментированные IP-пакеты. Идея состоит в том, чтобы разделить заголовок TCP на несколько пакетов для усложнения фильтрации пакетов и, следовательно, усложнить работу системам обнаружения вторжений и т. д.

`nmap -f 192.168.1.12`

`nmap -f fw2.nixcraft.net.in3`

`nmap -f 15 fw2.nixcraft.net.in4`

Set your own offset size with the --mtu option ##6

`nmap --mtu 32 192.168.1.1`

### №27 — скрытое сканирование с обманками
Существует возможность при сканировании скрыть свой IP-адрес среди любого количества фиктивных адресов-обманок. Для этого предназначена опция -D:

`nmap -n -Ddecoy-ip1,decoy-ip2,your-own-ip,decoy-ip3,decoy-ip4 remote-host-ip2`

`nmap -n -D192.168.1.5,10.5.1.2,172.1.2.4,3.4.2.1 192.168.1.5`

### №28 — спуфинг MAC-адресов
Утилита Nmap имеет в своем арсенале функцию спуфинга MAC-адресов. Стоит отметить, что spoofing attack — это ситуация, при которой одно устройство / приложение маскируется под другое, указывая его MAC-адрес.
Указываем ложный MAC-адрес
`nmap --spoof-mac MAC-ADDRESS-HERE 192.168.1.1`

Указываем дополнительные опции спуфинга
`nmap -v -sT -PN --spoof-mac MAC-ADDRESS-HERE 192.168.1.1`

Используем случайный MAC-адрес
В данном примере «0» означает, что Nmap выберет совершенно случайный MAC-адрес: `nmap -v -sT -PN --spoof-mac 0 192.168.1.1`

### №29 — сохранение вывода в текстовый файл при работе с Nmap для Linux
Если Вам нужно сохранить результаты вывода утилиты Nmap, то удобнее всего сделать это за счет перенаправления стандартного потока вывода в указанный текстовый файл с помощью знака «>»:

`nmap 192.168.1.1 > output.txt2`

`nmap -oN /path/to/filename 192.168.1.13`

`nmap -oN output.txt 192.168.1.1`

### №30 — сканирование веб-серверов и каналов в Nikto
Существует возможность осуществить сканирование веб-серверов и каналов в Nikto:

`nmap -p80 192.168.1.2/24 -oG - | /path/to/nikto.pl -h -2`

`nmap -p80,443 192.168.1.2/24 -oG - | /path/to/nikto.pl -h`

### №31 — ускорение процесса сканирования Nmap
Вы можете повысить скорость сканирования в Nmap. Для этого следует воспользоваться опцией -T:

`nmap -v -sS -A -T4 192.168.2.52`
